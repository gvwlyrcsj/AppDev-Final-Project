<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order History</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }
    .sidebar {
      flex: 0 0 250px;
      height: 160vh;
      background-color: #343a40;
      color: #fff;
      padding-top: 20px;
    }
    .sidebar .nav-link {
      color: #ddd;
      margin-bottom: 10px;
    }
    .content {
      flex-grow: 1;
      padding: 20px;
    }
    .sidebar img {
      width: 100px;
      height: 100px;
      object-fit: cover;
    }
    .d-flex {
      min-height: 100vh;
    }
    /* Print Media Adjustments */
    @media print {
      body * {
        visibility: hidden;
      }

      #printableArea, #printableArea * {
        visibility: visible;
      }

      #printableArea {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        overflow: hidden;
      }

      .no-print {
        display: none !important;
      }
    }
  </style>
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
</head>
<body>
  <div class="d-flex">
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="text-center mb-3">
          <img src="img/logo.png" alt="Logo">
        </div>
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link" href="/admin"><i class="bi bi-house-door"></i> Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/manageProduct"><i class="bi bi-box"></i> Manage Products</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/orders"><i class="bi bi-cart"></i> Orders</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/report"><i class="bi bi-bar-chart"></i> Report</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/feedback"><i class="bi bi-chat-dots"></i> Feedback</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/manageAdmin"><i class="bi bi-person-check"></i> Manage Admin</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/adminUserProfile"><i class="bi bi-person-circle"></i> Profile</a>
          </li>
        </ul>
      </nav>
  
    <!-- Main Content -->
    <div class="content">
        <div class="content flex-grow-1">
          <header class="p-3 bg-primary text-white">
            <h1>Orders</h1>
          </header>
  
      <!-- Filter Buttons -->
      <div class="btn-group mb-3" role="group" aria-label="Order Status Filter">
        <button type="button" class="btn" style="background-color: #03045e; color: white;" onclick="filterOrders('all')">All</button>
        <button type="button" class="btn" style="background-color: #0077b6; color: white;" onclick="filterOrders('pending')">Pending</button>
        <button type="button" class="btn" style="background-color: #00b4d8; color: white;" onclick="filterOrders('preparing')">Preparing</button>
        <button type="button" class="btn" style="background-color: #90e0ef; color: black;" onclick="filterOrders('delivered')">Delivered</button>
      </div>

      <table id="ordersTable" class="table table-bordered">
        <thead class="bg-secondary text-white">
          <tr>
            <th>Order ID</th>
            <th>Order Date</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="ordersBody">
          <% allOrders.forEach(order => { %>
            <tr data-status="<%= order.status %>">
              <td><%= order.order_id %></td>
              <td><%= order.order_date %></td>
              <td>
                <select class="order-status" data-order-id="<%= order.order_id %>">
                  <option value="pending" <%= order.status === 'pending' ? 'selected' : '' %>>Pending</option>
                  <option value="preparing" <%= order.status === 'preparing' ? 'selected' : '' %>>Preparing</option>
                  <option value="delivered" <%= order.status === 'delivered' ? 'selected' : '' %>>Delivered</option>
                </select>
              </td>
              <td>
                <button class="btn btn-info no-print" onclick="viewOrderDetails('<%= order.order_id %>')">View Details</button>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <!-- Order Details Modal -->
    <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" id="printableArea">
          <div class="modal-header">
            <h5 class="modal-title" id="orderDetailsModalLabel">Order Details</h5>
            <button type="button" class="btn-close no-print" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p><strong>Order ID:</strong> <span id="modalOrderId"></span></p>
            <p><strong>User Name:</strong> <span id="modalUserName"></span></p>
            <p><strong>Phone:</strong> <span id="modalUserPhone"></span></p>
            <p><strong>Address:</strong> <span id="modalUserAddress"></span></p>
            <h5>Products:</h5>
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>Product Name</th>
                  <th>Size</th>
                  <th>Quantity</th>
                  <th>Price</th>
                </tr>
              </thead>
              <tbody id="modalProductsBody"></tbody>
            </table>
          </div>
          <!-- Modal Footer -->
          <div class="modal-footer no-print">
            <button type="button" class="btn btn-secondary no-print" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary no-print" onclick="printOrderDetails()">Print</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Custom Scripts -->
  <script src="/js/orderHistory.js"></script>
</body>
</html>

<script>
    var allOrders = JSON.parse(document.getElementById('ordersBody').dataset.orders);

$(document).ready(function() {
  new DataTable('#ordersTable', {
    columnDefs: [
      { targets: [0], orderData: [0, 1] },
      { targets: [1], orderData: [1, 0] },
      { targets: [3], orderData: [3, 0] }
    ]
  });

  $('.order-status').change(function() {
    var orderId = $(this).data('order-id');
    var newStatus = $(this).val();

    $.ajax({
      url: '/update-order-status',
      method: 'POST',
      data: { orderId: orderId, status: newStatus },
      success: function(response) {
        alert('Order status updated successfully!');
      },
      error: function(xhr, status, error) {
        console.error('Error updating order status:', error);
        alert('Error updating order status. Please try again.');
      }
    });
  });
});

function filterOrders(status) {
  if (status === 'all') {
    $('#ordersBody tr').show();
  } else {
    $('#ordersBody tr').hide().filter('[data-status="' + status + '"]').show();
  }
}

function viewOrderDetails(orderId) {
  const order = allOrders.find(order => String(order.order_id) === String(orderId));
  if (!order) {
    alert('Order not found!');
    return;
  }

  $('#modalOrderId').text(order.order_id || 'N/A');
  $('#modalUserName').text(order.user?.name || 'N/A');
  $('#modalUserPhone').text(order.user?.phone || 'N/A');
  $('#modalUserAddress').text(order.user?.address || 'N/A');

  $('#modalProductsBody').empty();
  if (order.products && order.products.length > 0) {
    order.products.forEach(product => {
      $('#modalProductsBody').append(`
        <tr>
          <td>${product.product_name || 'N/A'}</td>
          <td>${product.size || 'N/A'}</td>
          <td>${product.quantity || 0}</td>
          <td>â‚±${(product.price * product.quantity).toFixed(2)}</td>
        </tr>
      `);
    });
  } else {
    $('#modalProductsBody').append('<tr><td colspan="4">No products found</td></tr>');
  }

  const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'), {});
  modal.show();
}

function printOrderDetails() {
  // Temporarily hide the non-printable elements
  var printContents = document.getElementById('printableArea').innerHTML;
  var originalContents = document.body.innerHTML;

  // Replace the page content with the printable content
  document.body.innerHTML = printContents;

  // Trigger the print
  window.print();

  // Restore original content after printing
  document.body.innerHTML = originalContents;
  window.location.reload(); // Reload the page to restore the original state
}

</script>