<%- include('partials/header') %>    

<div class="container py-5" style="max-width: 600px;">
    <div class="card shadow">
        <div class="card-header text-center bg-primary text-white">
            <h3>Receipt</h3>
        </div>
        <div class="card-body p-4">
            <h5 class="text-center mb-4">Thank you for your purchase!</h5>

            <!-- Shipping Address Section -->
            <div class="address-section mb-4">
                <label class="form-label">Shipping Address</label>
                <div class="address-display p-3 border rounded" onclick="openAddressPopup()">
                    <span id="selectedAddress">123 Main St, Bayuin, Socorro</span>
                    <button class="btn btn-sm btn-link float-right">Change</button>
                </div>
            </div>

            <!-- Address Popup Modal -->
            <div id="addressPopup" class="modal" style="display: none;">
                <div class="modal-content p-4">
                    <h5>Select or Add Address</h5>
                    <ul id="addressList" class="list-group mb-3">
                        <!-- Example addresses (these would be dynamic based on user data) -->
                        <li class="list-group-item" onclick="selectAddress('123 Main St, Bayuin, Socorro')">123 Main St, Bayuin, Socorro</li>
                        <li class="list-group-item" onclick="selectAddress('456 Another Rd, City')">456 Another Rd, City</li>
                    </ul>
                    <input type="text" id="newAddress" class="form-control" placeholder="Add new address">
                    <button onclick="addAddress()" class="btn btn-primary mt-2">Add</button>
                    <button onclick="closeAddressPopup()" class="btn btn-secondary mt-2">Close</button>
                </div>
            </div>

            <% if (cartItems.length === 0) { %>
                <div class="text-center">
                    <p>No items to checkout.</p>
                    <a href="/cart" class="btn btn-primary">Return to Cart</a>
                </div>
            <% } else { %>
                <table class="table table-borderless">
                    <thead class="border-bottom">
                        <tr>
                            <th>Image</th>
                            <th>Product Name</th>
                            <th class="text-center">Size</th>
                            <th class="text-center">Quantity</th>
                            <th class="text-right">Price</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% cartItems.forEach((item, index) => { %>
                            <tr>
                                <td>
                                    <% if (item.imageUrl) { %>
                                        <img src="<%= item.imageUrl %>" alt="<%= item.name %>" style="width: 60px; height: auto;">
                                    <% } else { %>
                                        <span>No image</span>
                                    <% } %>
                                </td>
                                <td><%= item.name %></td>
                                <td class="text-center">
                                    <select name="size" class="form-select form-select-sm" onchange="updatePrice(<%= index %>)" id="size-<%= index %>">
                                        <option value="S" <% if(item.size === 'S') { %>selected<% } %>>S</option>
                                        <option value="M" <% if(item.size === 'M') { %>selected<% } %>>M</option>
                                        <option value="L" <% if(item.size === 'L') { %>selected<% } %>>L</option>
                                        <option value="XL" <% if(item.size === 'XL') { %>selected<% } %>>XL</option>
                                    </select>
                                </td>
                                <td class="text-center">
                                    <input type="number" name="quantity" value="<%= item.quantity %>" min="1" class="form-control form-control-sm" onchange="updatePrice(<%= index %>)" id="quantity-<%= index %>">
                                </td>
                                <td class="text-right">$<span id="price-<%= index %>"><%= item.price * item.quantity %></span></td>
                            </tr>
                        <% }) %>
                    </tbody>
                    <tfoot class="border-top">
                        <tr>
                            <th colspan="4" class="text-right">Total</th>
                            <th class="text-right">$<span id="total"><%= total %></span></th>
                        </tr>
                    </tfoot>
                </table>

                <!-- Payment Options Section -->
                <div class="mt-4">
                    <label for="paymentMethod" class="form-label">Payment Method</label>
                    <select id="paymentMethod" name="paymentMethod" class="form-select">
                        <option value="credit_card">Credit Card</option>
                        <option value="paypal">PayPal</option>
                        <option value="cash_on_delivery">Cash on Delivery</option>
                    </select>
                </div>

                <!-- Confirm and Cancel Section -->
                <div class="text-center mt-4">
                    <button id="confirmOrderBtn" class="btn btn-success btn-lg mr-2">Confirm</button>
                    <a href="/cart" class="btn btn-danger btn-lg">Cancel</a>
                </div>
            <% } %>
        </div>
    </div>
</div>

<script>
    const sizePrices = { 'S': 59, 'M': 69, 'L': 79, 'XL': 89 };

    function updatePrice(index) {
        const size = document.getElementById(`size-${index}`).value;
        const quantity = parseInt(document.getElementById(`quantity-${index}`).value) || 1;
        const newPrice = sizePrices[size] * quantity;
        document.getElementById(`price-${index}`).innerText = newPrice.toFixed(2);
        updateTotal();
    }

    function updateTotal() {
        let total = 0;
        <% cartItems.forEach((item, index) => { %>
            const itemPrice = parseFloat(document.getElementById(`price-<%= index %>`).innerText);
            total += itemPrice;
        <% }) %>
        document.getElementById('total').innerText = total.toFixed(2);
    }

    function openAddressPopup() {
        document.getElementById('addressPopup').style.display = 'block';
    }

    function closeAddressPopup() {
        document.getElementById('addressPopup').style.display = 'none';
    }

    function selectAddress(address) {
        document.getElementById('selectedAddress').innerText = address;
        closeAddressPopup();
    }

    function addAddress() {
        const newAddress = document.getElementById('newAddress').value;
        if (newAddress) {
            const addressList = document.getElementById('addressList');
            const newAddressItem = document.createElement('li');
            newAddressItem.className = 'list-group-item';
            newAddressItem.innerText = newAddress;
            newAddressItem.onclick = () => selectAddress(newAddress);
            addressList.appendChild(newAddressItem);
            document.getElementById('newAddress').value = '';
        }
    }

    document.getElementById('confirmOrderBtn').addEventListener('click', function() {
        const cartItems = <%- JSON.stringify(cartItems) %>;  // Get cart items from EJS
        const userId = <%= userId %>;  // Get user ID from EJS
        const address = document.getElementById('selectedAddress').innerText;
        const paymentMethod = document.getElementById('paymentMethod').value;

        fetch('/order/checkout/confirm', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                cartItems: cartItems,
                userId: userId,
                address: address,
                paymentMethod: paymentMethod
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log(data);
            window.location.href = '/order/success';  // Redirect to success page
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });
</script>

<%- include('partials/footer') %>
